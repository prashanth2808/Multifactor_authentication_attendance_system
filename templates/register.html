{% extends "base.html" %}

{% block title %}User Registration - Biometric System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    User Registration
                </h4>
                <small class="text-light">Enroll Face + Voice Biometrics</small>
            </div>
            <div class="card-body">
                <!-- Registration Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="step-indicator" id="step1">
                                <div class="step-circle active">
                                    <i class="fas fa-user"></i>
                                </div>
                                <small>User Info</small>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-indicator" id="step2">
                                <div class="step-circle">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <small>Face Photos</small>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-indicator" id="step3">
                                <div class="step-circle">
                                    <i class="fas fa-microphone"></i>
                                </div>
                                <small>Voice Clips</small>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-indicator" id="step4">
                                <div class="step-circle">
                                    <i class="fas fa-check"></i>
                                </div>
                                <small>Complete</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: User Information -->
                <div id="userInfoStep" class="registration-step">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <h5 class="mb-4 text-center">
                                <i class="fas fa-user me-2"></i>
                                User Information
                            </h5>
                            
                            <form id="userInfoForm">
                                <div class="mb-3">
                                    <label for="fullName" class="form-label">
                                        <i class="fas fa-user me-2"></i>
                                        Full Name
                                    </label>
                                    <input type="text" class="form-control" id="fullName" required>
                                    <div class="form-text">Enter your complete name as it appears on official documents</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope me-2"></i>
                                        Email Address
                                    </label>
                                    <input type="email" class="form-control" id="email" required>
                                    <div class="form-text">This will be your unique identifier in the system</div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Continue to Face Capture
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Face Photo Capture -->
                <div id="faceStep" class="registration-step" style="display: none;">
                    <div class="row">
                        <div class="col-lg-8 mx-auto">
                            <h5 class="mb-4 text-center">
                                <i class="fas fa-camera me-2"></i>
                                Face Photo Capture
                            </h5>
                            
                            <div class="camera-container mb-4" id="faceCameraContainer">
                                <img id="faceCameraFeed" class="camera-feed" style="display: none;">
                                <div class="loading-spinner" id="faceCameraLoading">
                                    <div class="spinner-border text-light" role="status"></div>
                                    <p class="text-light mt-2">Initializing camera...</p>
                                </div>
                            </div>

                            <div class="text-center mb-4">
                                <div id="faceStatusMessage" class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Position yourself in front of the camera. We'll capture 3 photos automatically.
                                </div>
                            </div>

                            <!-- Photo Preview -->
                            <div class="row g-3 mb-4" id="photoPreview" style="display: none;">
                                <div class="col-4">
                                    <div class="photo-slot">
                                        <img id="photo1" class="img-fluid rounded">
                                        <div class="photo-label">Photo 1</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="photo-slot">
                                        <img id="photo2" class="img-fluid rounded">
                                        <div class="photo-label">Photo 2</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="photo-slot">
                                        <img id="photo3" class="img-fluid rounded">
                                        <div class="photo-label">Photo 3</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button id="captureFaceBtn" class="btn btn-success btn-lg me-3" onclick="captureProfileFace()">
                                    <i class="fas fa-camera me-2"></i>
                                    Capture Face Photos
                                </button>
                                <button id="retakeFaceBtn" class="btn btn-warning btn-lg me-3" onclick="retakeProfileFace()" style="display: none;">
                                    <i class="fas fa-redo me-2"></i>
                                    Retake Photos
                                </button>
                                <button id="continueVoiceBtn" class="btn btn-primary btn-lg" onclick="continueToVoice()" style="display: none;">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    Continue to Voice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Voice Recording -->
                <div id="voiceStep" class="registration-step" style="display: none;">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <h5 class="mb-4 text-center">
                                <i class="fas fa-microphone me-2"></i>
                                Voice Profile Setup
                            </h5>
                            
                            <div class="voice-recording-area">
                                <div class="text-center mb-4">
                                    <div class="voice-animation mb-3">
                                        <i class="fas fa-microphone fa-4x text-primary" id="voiceIcon"></i>
                                    </div>
                                    
                                    <div id="voiceInstructions">
                                        <h6>We'll record 3 voice clips</h6>
                                        <p class="text-muted">Each recording will be 5 seconds long</p>
                                    </div>
                                </div>

                                <!-- Voice Prompts -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <div class="prompt-card" id="prompt1">
                                            <div class="prompt-number">1</div>
                                            <div class="prompt-text">"My name is [Your Name]"</div>
                                            <div class="prompt-status">
                                                <i class="fas fa-clock text-muted"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="prompt-card" id="prompt2">
                                            <div class="prompt-number">2</div>
                                            <div class="prompt-text">"Today is a beautiful day"</div>
                                            <div class="prompt-status">
                                                <i class="fas fa-clock text-muted"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="prompt-card" id="prompt3">
                                            <div class="prompt-number">3</div>
                                            <div class="prompt-text">"I am registering for biometric access"</div>
                                            <div class="prompt-status">
                                                <i class="fas fa-clock text-muted"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recording Controls -->
                                <div class="text-center mb-4">
                                    <div id="recordingProgress" style="display: none;">
                                        <div class="progress progress-custom mb-3">
                                            <div class="progress-bar" id="voiceProgressBar"></div>
                                        </div>
                                        <p class="text-muted">Recording clip <span id="currentClip">1</span> of 3...</p>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button id="startVoiceRecBtn" class="btn btn-success btn-lg me-3" onclick="startVoiceRecording()">
                                        <i class="fas fa-microphone me-2"></i>
                                        Start Voice Recording
                                    </button>
                                    <button id="completeRegBtn" class="btn btn-primary btn-lg" onclick="completeRegistration()" style="display: none;">
                                        <i class="fas fa-check me-2"></i>
                                        Complete Registration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Registration Complete -->
                <div id="completeStep" class="registration-step" style="display: none;">
                    <div class="text-center">
                        <div class="success-animation mb-4">
                            <i class="fas fa-check-circle fa-5x text-success"></i>
                        </div>
                        <h3 class="text-success mb-3">Registration Successful!</h3>
                        <p class="lead">Your biometric profile has been created successfully.</p>
                        
                        <div class="row g-3 mt-4 justify-content-center">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value text-success">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <div class="metric-label">3 Face Photos</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value text-success">
                                        <i class="fas fa-microphone"></i>
                                    </div>
                                    <div class="metric-label">3 Voice Clips</div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-success btn-lg me-3" onclick="window.location.href='{{ url_for('session_page') }}'">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Try Authentication
                            </button>
                            <button class="btn btn-primary btn-lg" onclick="window.location.href='{{ url_for('index') }}'">
                                <i class="fas fa-home me-2"></i>
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-indicator {
    text-align: center;
    flex: 1;
    position: relative;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.step-circle.active {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    color: white;
}

.step-circle.completed {
    background: linear-gradient(135deg, var(--success-color), #2ecc71);
    color: white;
}

.step-line {
    flex: 1;
    height: 2px;
    background: #e9ecef;
    margin: 25px 20px 0;
}

.step-line.active {
    background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
}

.camera-container {
    position: relative;
    min-height: 400px;
    background: #000;
    border-radius: 15px;
    overflow: hidden;
}

.photo-slot {
    text-align: center;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 20px;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
}

.photo-slot.filled {
    border-color: var(--success-color);
    background: rgba(39, 174, 96, 0.1);
}

.photo-label {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 500;
}

.prompt-card {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.prompt-card.active {
    border-color: var(--secondary-color);
    background: rgba(52, 152, 219, 0.1);
    transform: translateY(-5px);
}

.prompt-card.completed {
    border-color: var(--success-color);
    background: rgba(39, 174, 96, 0.1);
}

.prompt-number {
    width: 30px;
    height: 30px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
}

.prompt-text {
    font-size: 0.9rem;
    color: var(--dark-color);
    font-weight: 500;
    margin-bottom: 10px;
}

.prompt-status {
    font-size: 1.2rem;
}

.voice-animation {
    animation: voicePulse 2s infinite;
}

.voice-animation.recording {
    animation: voiceRecord 0.5s infinite alternate;
}

@keyframes voicePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
}

@keyframes voiceRecord {
    0% { color: var(--danger-color); transform: scale(1); }
    100% { color: #c0392b; transform: scale(1.1); }
}

.success-animation {
    animation: successBounce 1s ease-out;
}

@keyframes successBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let registrationData = {};
let currentStep = 1;
let faceCameraInterval = null;
let voiceRecordingInProgress = false;
let recordedClips = 0;

document.addEventListener('DOMContentLoaded', function() {
    initializeFaceCamera();
});

// Step 1: User Information
document.getElementById('userInfoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!name || !email) {
        showAlert('Please fill in all fields', 'warning');
        return;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    showLoading(submitBtn, 'Checking...');
    
    // Register user info
    fetch('/api/register_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ready_for_face_capture') {
            registrationData.name = name;
            registrationData.email = email;
            nextStep();
        } else {
            throw new Error(data.error || 'Registration failed');
        }
    })
    .catch(error => {
        showAlert(error.message, 'danger');
        hideLoading(submitBtn, '<i class="fas fa-arrow-right me-2"></i>Continue to Face Capture');
    });
});

function initializeFaceCamera() {
    faceCameraInterval = setInterval(async () => {
        try {
            // Only fetch camera feed when on face step
            if (currentStep === 2 && !voiceRecordingInProgress) {
                const response = await fetch('/api/capture_frame');
                const data = await response.json();
                
                if (data.image) {
                    const cameraFeed = document.getElementById('faceCameraFeed');
                    const cameraLoading = document.getElementById('faceCameraLoading');
                    
                    cameraFeed.src = data.image;
                    cameraFeed.style.display = 'block';
                    cameraLoading.style.display = 'none';
                    
                    updateFaceStatus(data.faces_detected);
                }
            }
        } catch (error) {
            console.error('Face camera error:', error);
            // Don't spam errors, just log them
        }
    }, 2500); // Even slower polling for registration - 2.5 seconds
}

function updateFaceStatus(facesDetected) {
    const statusMessage = document.getElementById('faceStatusMessage');
    const captureBtn = document.getElementById('captureFaceBtn');
    
    if (currentStep === 2) {  // Only update if we're on face step
        if (facesDetected === 1) {
            statusMessage.className = 'alert alert-success';
            statusMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i>Perfect! One face detected. Ready to capture.';
            captureBtn.disabled = false;
        } else if (facesDetected > 1) {
            statusMessage.className = 'alert alert-warning';
            statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Multiple faces detected. Please ensure only one person is visible.';
            captureBtn.disabled = true;
        } else {
            statusMessage.className = 'alert alert-info';
            statusMessage.innerHTML = '<i class="fas fa-info-circle me-2"></i>Position yourself in front of the camera.';
            captureBtn.disabled = true;
        }
    }
}

async function captureProfileFace() {
    const captureBtn = document.getElementById('captureFaceBtn');
    showLoading(captureBtn, 'Capturing...');
    
    try {
        const response = await fetch('/api/capture_face_photos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'face_captured') {
            showAlert('Face photos captured successfully!', 'success');
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('retakeFaceBtn').style.display = 'inline-block';
            document.getElementById('continueVoiceBtn').style.display = 'inline-block';
            captureBtn.style.display = 'none';
            
            // Show photo placeholders (actual photos would be loaded here)
            for (let i = 1; i <= 3; i++) {
                const photoSlot = document.getElementById(`photo${i}`).parentElement;
                photoSlot.classList.add('filled');
                photoSlot.innerHTML = `
                    <div class="photo-placeholder">
                        <i class="fas fa-check-circle fa-3x text-success"></i>
                        <div class="photo-label">Photo ${i} âœ“</div>
                    </div>
                `;
            }
        } else {
            throw new Error(data.error || 'Face capture failed');
        }
    } catch (error) {
        showAlert(error.message, 'danger');
        hideLoading(captureBtn, '<i class="fas fa-camera me-2"></i>Capture Face Photos');
    }
}

function retakeProfileFace() {
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('retakeFaceBtn').style.display = 'none';
    document.getElementById('continueVoiceBtn').style.display = 'none';
    document.getElementById('captureFaceBtn').style.display = 'inline-block';
    
    // Reset photo slots
    for (let i = 1; i <= 3; i++) {
        const photoSlot = document.getElementById(`photo${i}`).parentElement;
        photoSlot.classList.remove('filled');
        photoSlot.innerHTML = `
            <img id="photo${i}" class="img-fluid rounded">
            <div class="photo-label">Photo ${i}</div>
        `;
    }
}

function continueToVoice() {
    nextStep();
}

async function startVoiceRecording() {
    const startBtn = document.getElementById('startVoiceRecBtn');
    const progressDiv = document.getElementById('recordingProgress');
    const voiceIcon = document.getElementById('voiceIcon');
    
    showLoading(startBtn, 'Recording Voice...');
    progressDiv.style.display = 'block';
    voiceIcon.classList.add('recording');
    
    try {
        const response = await fetch('/api/capture_voice_clips', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'registration_complete') {
            // Mark all prompts as completed
            for (let i = 1; i <= 3; i++) {
                const promptCard = document.getElementById(`prompt${i}`);
                promptCard.classList.add('completed');
                promptCard.querySelector('.prompt-status').innerHTML = '<i class="fas fa-check-circle text-success"></i>';
            }
            
            document.getElementById('completeRegBtn').style.display = 'inline-block';
            startBtn.style.display = 'none';
            progressDiv.style.display = 'none';
            voiceIcon.classList.remove('recording');
            
            showAlert('Voice profile created successfully!', 'success');
        } else {
            throw new Error(data.error || 'Voice recording failed');
        }
    } catch (error) {
        showAlert(error.message, 'danger');
        hideLoading(startBtn, '<i class="fas fa-microphone me-2"></i>Start Voice Recording');
        progressDiv.style.display = 'none';
        voiceIcon.classList.remove('recording');
    }
}

function completeRegistration() {
    nextStep();
}

function nextStep() {
    // Hide current step
    document.querySelectorAll('.registration-step').forEach(step => {
        step.style.display = 'none';
    });
    
    // Update step indicator
    updateStepIndicator(currentStep, 'completed');
    currentStep++;
    updateStepIndicator(currentStep, 'active');
    
    // Show next step
    const stepNames = ['', 'userInfoStep', 'faceStep', 'voiceStep', 'completeStep'];
    if (stepNames[currentStep]) {
        document.getElementById(stepNames[currentStep]).style.display = 'block';
    }
}

function updateStepIndicator(step, state) {
    if (step > 4) return;
    
    const stepElement = document.getElementById(`step${step}`);
    const circle = stepElement.querySelector('.step-circle');
    
    circle.className = `step-circle ${state}`;
    
    if (step > 1) {
        const prevLine = stepElement.previousElementSibling;
        if (prevLine && prevLine.classList.contains('step-line')) {
            if (state === 'completed' || state === 'active') {
                prevLine.classList.add('active');
            }
        }
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (faceCameraInterval) {
        clearInterval(faceCameraInterval);
    }
    // Stop the global camera
    fetch('/api/camera/stop').catch(() => {}); // Ignore errors on cleanup
});

// Also cleanup when leaving the page
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, pause camera
        if (faceCameraInterval) {
            clearInterval(faceCameraInterval);
            faceCameraInterval = null;
        }
    } else {
        // Page is visible again, restart camera if needed on face step
        if (!faceCameraInterval && currentStep === 2) {
            initializeFaceCamera();
        }
    }
});
</script>
{% endblock %}