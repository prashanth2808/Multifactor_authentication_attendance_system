{% extends "base.html" %}

{% block title %}Biometric Login/Logout - Biometric System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    Biometric Authentication
                </h4>
                <small class="text-light">Face + Voice Recognition System</small>
            </div>
            <div class="card-body">
                <!-- Authentication Steps -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="step-indicator" id="step1">
                                <div class="step-circle active">
                                    <i class="fas fa-video"></i>
                                </div>
                                <small>Face Scan</small>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-indicator" id="step2">
                                <div class="step-circle">
                                    <i class="fas fa-microphone"></i>
                                </div>
                                <small>Voice Verify</small>
                            </div>
                            <div class="step-line"></div>
                            <div class="step-indicator" id="step3">
                                <div class="step-circle">
                                    <i class="fas fa-check"></i>
                                </div>
                                <small>Complete</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Section -->
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="camera-container mb-4" id="cameraContainer">
                            <img id="cameraFeed" class="camera-feed" style="display: none;">
                            <div class="loading-spinner" id="cameraLoading">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Initializing camera...</span>
                                </div>
                                <p class="text-light mt-2">Initializing camera...</p>
                            </div>
                            <div class="camera-overlay" id="cameraOverlay">
                                <div class="face-detection-box" id="faceBox" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Status Display -->
                        <div class="text-center mb-4">
                            <div id="statusMessage" class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Please position yourself in front of the camera and wait for face detection
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center">
                            <button id="startAuthBtn" class="btn btn-primary btn-lg me-3" onclick="startAuthentication()">
                                <i class="fas fa-play me-2"></i>
                                Start Authentication
                            </button>
                            <button id="cancelBtn" class="btn btn-secondary btn-lg" onclick="cancelAuthentication()">
                                <i class="fas fa-times me-2"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Voice Verification Modal -->
                <div class="modal fade" id="voiceModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-microphone me-2"></i>
                                    Voice Verification
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div id="userInfo" class="mb-4" style="display: none;">
                                    <div class="user-avatar mb-3">
                                        <i class="fas fa-user-circle fa-3x text-primary"></i>
                                    </div>
                                    <h6 id="userName"></h6>
                                    <p class="text-muted" id="userEmail"></p>
                                    <p class="text-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Face verified (<span id="faceConfidence"></span>)
                                    </p>
                                </div>

                                <div id="voiceInstructions">
                                    <div class="voice-animation mb-3">
                                        <i class="fas fa-microphone fa-3x text-primary pulse-animation"></i>
                                    </div>
                                    <h6>Speak clearly into your microphone</h6>
                                    <p class="text-muted">Say any phrase for 5 seconds</p>
                                    
                                    <div class="progress progress-custom mb-3" style="display: none;" id="voiceProgress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <div id="voiceResult" style="display: none;">
                                    <!-- Voice verification result will be displayed here -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="startVoiceBtn" onclick="startVoiceVerification()">
                                    <i class="fas fa-microphone me-2"></i>
                                    Start Voice Verification
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Modal -->
                <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Authentication Successful
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <div id="successContent">
                                    <!-- Success content will be populated here -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" onclick="location.reload()">
                                    <i class="fas fa-refresh me-2"></i>
                                    New Authentication
                                </button>
                                <button type="button" class="btn btn-primary" onclick="window.location.href='/'">
                                    <i class="fas fa-home me-2"></i>
                                    Return to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-indicator {
    text-align: center;
    flex: 1;
    position: relative;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.step-circle.active {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    color: white;
}

.step-circle.completed {
    background: linear-gradient(135deg, var(--success-color), #2ecc71);
    color: white;
}

.step-line {
    flex: 1;
    height: 2px;
    background: #e9ecef;
    margin: 25px 20px 0;
}

.step-line.active {
    background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
}

.camera-container {
    position: relative;
    min-height: 400px;
    background: #000;
    border-radius: 15px;
    overflow: hidden;
}

.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
}

.face-detection-box {
    position: absolute;
    border: 3px solid #00ff00;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    transition: all 0.3s ease;
}

.voice-animation {
    animation: voicePulse 1.5s infinite;
}

@keyframes voicePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.user-avatar {
    position: relative;
}

.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let authenticationInProgress = false;
let cameraInterval = null;
let currentUser = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCamera();
});

async function initializeCamera() {
    try {
        const cameraFeed = document.getElementById('cameraFeed');
        const cameraLoading = document.getElementById('cameraLoading');
        
        // Start camera feed with reduced polling frequency
        cameraInterval = setInterval(async () => {
            try {
                // Only fetch if not currently authenticating
                if (!authenticationInProgress) {
                    const response = await fetch('/api/capture_frame');
                    const data = await response.json();
                    
                    if (data.image) {
                        cameraFeed.src = data.image;
                        cameraFeed.style.display = 'block';
                        cameraLoading.style.display = 'none';
                        
                        // Update face detection status
                        updateFaceDetectionStatus(data.faces_detected);
                    }
                }
            } catch (error) {
                console.error('Camera feed error:', error);
                // Don't spam errors, just log them
            }
        }, 2000); // Reduced to 2 seconds instead of 1
        
    } catch (error) {
        console.error('Camera initialization error:', error);
        showAlert('Camera initialization failed. Please check permissions.', 'danger');
    }
}

function updateFaceDetectionStatus(facesDetected) {
    const statusMessage = document.getElementById('statusMessage');
    const startAuthBtn = document.getElementById('startAuthBtn');
    
    if (facesDetected === 1) {
        statusMessage.className = 'alert alert-success';
        statusMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i>Face detected! Ready for authentication';
        startAuthBtn.disabled = false;
    } else if (facesDetected > 1) {
        statusMessage.className = 'alert alert-warning';
        statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Multiple faces detected. Please ensure only one person is visible';
        startAuthBtn.disabled = true;
    } else {
        statusMessage.className = 'alert alert-info';
        statusMessage.innerHTML = '<i class="fas fa-info-circle me-2"></i>Please position yourself in front of the camera';
        startAuthBtn.disabled = true;
    }
}

async function startAuthentication() {
    if (authenticationInProgress) return;
    
    authenticationInProgress = true;
    const startAuthBtn = document.getElementById('startAuthBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    showLoading(startAuthBtn, 'Authenticating...');
    cancelBtn.disabled = true;
    
    // Update step indicator
    updateStepIndicator(1, 'active');
    
    try {
        const response = await fetch('/api/authenticate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Face verification successful
            currentUser = data;
            updateStepIndicator(1, 'completed');
            updateStepIndicator(2, 'active');
            
            // Show voice verification modal
            showVoiceModal();
        } else {
            throw new Error(data.error || 'Authentication failed');
        }
        
    } catch (error) {
        console.error('Authentication error:', error);
        showAlert(error.message, 'danger');
        resetAuthentication();
    }
}

function showVoiceModal() {
    const modal = new bootstrap.Modal(document.getElementById('voiceModal'));
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const faceConfidence = document.getElementById('faceConfidence');
    
    userName.textContent = currentUser.name;
    userEmail.textContent = currentUser.email;
    faceConfidence.textContent = (currentUser.confidence * 100).toFixed(1) + '%';
    
    userInfo.style.display = 'block';
    modal.show();
}

async function startVoiceVerification() {
    const startVoiceBtn = document.getElementById('startVoiceBtn');
    const voiceProgress = document.getElementById('voiceProgress');
    const voiceInstructions = document.getElementById('voiceInstructions');
    
    showLoading(startVoiceBtn, 'Recording...');
    voiceProgress.style.display = 'block';
    
    // Animate progress bar
    const progressBar = voiceProgress.querySelector('.progress-bar');
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        progressBar.style.width = progress + '%';
        if (progress >= 100) {
            clearInterval(progressInterval);
        }
    }, 100);
    
    try {
        const response = await fetch('/api/voice_verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Voice verification successful
            updateStepIndicator(2, 'completed');
            updateStepIndicator(3, 'active');
            
            // Close voice modal and show success
            bootstrap.Modal.getInstance(document.getElementById('voiceModal')).hide();
            showSuccessModal(data);
            
        } else {
            throw new Error(data.error || 'Voice verification failed');
        }
        
    } catch (error) {
        console.error('Voice verification error:', error);
        showAlert(error.message, 'danger');
        
        // Reset voice modal
        hideLoading(startVoiceBtn, 'Start Voice Verification');
        voiceProgress.style.display = 'none';
        progressBar.style.width = '0%';
    }
}

function showSuccessModal(data) {
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    const successContent = document.getElementById('successContent');
    
    const actionColor = data.action === 'LOGIN' ? 'success' : 'info';
    const actionIcon = data.action === 'LOGIN' ? 'sign-in-alt' : 'sign-out-alt';
    
    successContent.innerHTML = `
        <div class="user-avatar mb-3">
            <i class="fas fa-user-circle fa-4x text-${actionColor}"></i>
        </div>
        <h5 class="text-${actionColor}">${data.action} SUCCESSFUL</h5>
        <p class="lead">${currentUser.name}</p>
        <p class="text-muted">${currentUser.email}</p>
        
        <div class="row g-3 mt-3">
            <div class="col-6">
                <div class="metric-card">
                    <div class="metric-value text-primary">${(data.face_confidence * 100).toFixed(1)}%</div>
                    <div class="metric-label">Face Match</div>
                </div>
            </div>
            <div class="col-6">
                <div class="metric-card">
                    <div class="metric-value text-success">${(data.voice_confidence * 100).toFixed(1)}%</div>
                    <div class="metric-label">Voice Match</div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-${actionColor} mt-3">
            <i class="fas fa-${actionIcon} me-2"></i>
            ${data.message}
        </div>
    `;
    
    updateStepIndicator(3, 'completed');
    modal.show();
    
    // Reset authentication state
    setTimeout(() => {
        resetAuthentication();
    }, 1000);
}

function updateStepIndicator(step, state) {
    const stepElement = document.getElementById(`step${step}`);
    const circle = stepElement.querySelector('.step-circle');
    
    circle.className = `step-circle ${state}`;
    
    if (step > 1) {
        const prevLine = stepElement.previousElementSibling;
        if (prevLine && prevLine.classList.contains('step-line')) {
            if (state === 'completed' || state === 'active') {
                prevLine.classList.add('active');
            }
        }
    }
}

function cancelAuthentication() {
    resetAuthentication();
    showAlert('Authentication cancelled', 'info');
}

function resetAuthentication() {
    authenticationInProgress = false;
    currentUser = null;
    
    const startAuthBtn = document.getElementById('startAuthBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    hideLoading(startAuthBtn, '<i class="fas fa-play me-2"></i>Start Authentication');
    cancelBtn.disabled = false;
    
    // Reset step indicators
    for (let i = 1; i <= 3; i++) {
        const circle = document.getElementById(`step${i}`).querySelector('.step-circle');
        circle.className = 'step-circle';
    }
    document.getElementById('step1').querySelector('.step-circle').classList.add('active');
    
    // Reset step lines
    document.querySelectorAll('.step-line').forEach(line => {
        line.classList.remove('active');
    });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (cameraInterval) {
        clearInterval(cameraInterval);
    }
    // Stop the global camera
    fetch('/api/camera/stop').catch(() => {}); // Ignore errors on cleanup
});

// Also cleanup when leaving the page
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, pause camera
        if (cameraInterval) {
            clearInterval(cameraInterval);
            cameraInterval = null;
        }
    } else {
        // Page is visible again, restart camera if needed
        if (!cameraInterval && !authenticationInProgress) {
            initializeCamera();
        }
    }
});
</script>
{% endblock %}